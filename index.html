<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LanzaFolio - חקר מניות</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- עיצוב אלגנטי (Dark Mode) --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #0d6efd; /* כחול מודרני */
            --text-color: #e0e0e0;
            --text-secondary: #aaaaaa;
            --green: #198754;
            --red: #dc3545;
            --buy: #26a69a;
            --sell: #ef5350;
            --hold: #ffca28;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            padding: 20px;
        }

        /* --- לוגו וכותרת --- */
        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .logo-svg {
            width: 45px;
            height: 45px;
        }
        .header h1 {
            color: var(--text-color);
            font-size: 2.5em;
            margin: 0;
            font-weight: 300; /* פונט קל */
        }
        /* הדגשת האותיות L ו-F בשם */
        .header h1 strong {
            font-weight: 700;
            color: var(--primary-color);
        }

        h2, h3 { color: var(--primary-color); }

        /* --- חיפוש --- */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            font-size: 1.1em;
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--text-secondary);
            border-radius: 6px;
        }
        button {
            padding: 12px 20px;
            font-size: 1.1em;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0b5ed7; }

        /* --- דף הבית (Market Movers) --- */
        #homepage-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .mover-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            max-height: 600px; /* גובה מקסימלי לרשימה */
            overflow-y: auto; /* הוספת גלילה */
        }
        .mover-card h3 { margin-top: 0; }
        .mover-list { list-style: none; padding: 0; }
        .mover-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            font-size: 1.1em;
        }
        .mover-list li:last-child { border: none; }
        .mover-list .symbol { font-weight: bold; }
        .mover-list .change-gainer { color: var(--green); }
        .mover-list .change-loser { color: var(--red); }
        .mover-list .volume { color: var(--text-secondary); font-size: 0.9em; }

        /* --- תוצאות חיפוש (Stock Details) --- */
        #stock-details-view { display: none; }
        .stock-header {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
        }
        .stock-header h1 { margin: 0; font-size: 2.5em; }
        .stock-header .sub-header { font-size: 1.2em; color: var(--text-secondary); }
        .price { font-size: 2.8em; font-weight: bold; margin: 10px 0; }
        .change { font-size: 1.5em; }

        /* --- גרפים --- */
        #chart-container {
            width: 100%;
            height: 400px;
            margin: 30px 0;
        }

        /* --- לשוניות (טאבים) --- */
        .tabs-nav {
            display: flex;
            border-bottom: 1px solid #444;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1.1em;
            background: none;
            border: none;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 8px;
        }
        .tab-content.active { display: block; }

        /* --- תוכן הטאבים --- */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .data-point {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 6px;
        }
        .data-point .label {
            font-size: 0.9em;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 5px;
        }
        .data-point .value {
            font-size: 1.3em;
            font-weight: bold;
        }

        /* חדשות */
        .news-list { list-style: none; padding: 0; }
        .news-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .news-item a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 1.2em;
        }
        .news-item a:hover { text-decoration: underline; }
        .news-item p { margin: 5px 0; color: var(--text-secondary); }

        /* אנליסטים */
        #analyst-chart-container {
            max-width: 400px;
            margin: auto;
        }

        /* --- לואדר (טעינה) --- */
        #loader {
            text-align: center;
            font-size: 1.5em;
            padding: 50px;
            display: none; /* מוסתר בהתחלה */
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <svg class="logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:var(--primary-color);" />
                        <stop offset="100%" style="stop-color:#07b095;" />
                    </linearGradient>
                </defs>
                <path d="M 25 80 L 25 20 L 35 20 L 35 70 L 75 30 L 85 37 L 35 77 L 35 80 Z" fill="url(#logoGradient)" />
            </svg>
            <h1><strong>L</strong>anza<strong>F</strong>olio</h1>
        </div>

        <div class="search-box">
            <input type="text" id="stockSymbol" placeholder="הקלד סימול מניה (למשל: AAPL)">
            <button onclick="searchStock()">חפש</button>
        </div>

        <div id="loader">טוען נתונים... 🔎</div>

        <div id="homepage-view">
            <div class="mover-card">
                <h3>המניות העולות (Top Gainers)</h3>
                <ul class="mover-list" id="top-gainers-list"></ul>
            </div>
            <div class="mover-card">
                <h3>המניות הפעילות (Most Active)</h3>
                <ul class="mover-list" id="most-active-list"></ul>
            </div>
        </div>

        <div id="stock-details-view">

            <div class="stock-header">
                <h1 id="companyName"></h1>
                <span class="sub-header" id="companyTicker"></span>
                <div class="price" id="stockPrice"></div>
                <div class="change" id="stockChange"></div>
            </div>

            <div id="chart-container"></div>
            <div id="flags"></div>

            <div class="tabs-nav">
                <button class="tab-button active" onclick="showTab('overview')">סקירה כללית</button>
                <button class="tab-button" onclick="showTab('financials')">דוחות כספיים</button>
                <button class="tab-button" onclick="showTab('news')">חדשות</button>
                <button class="tab-button" onclick="showTab('analysts')">המלצות אנליסטים</button>
            </div>

            <div id="tabs-content">
                <div id="overview" class="tab-content active">
                    <h3>אודות החברה</h3>
                    <p id="companyDescription"></p>
                    <hr>
                    <div class="data-grid">
                        <div class="data-point"><span class="label">שווי שוק</span><span class="value" id="marketCap"></span></div>
                        <div class="data-point"><span class="label">מכפיל רווח (P/E)</span><span class="value" id="peRatio"></span></div>
                        <div class="data-point"><span class="label">תשואת דיבידנד</span><span class="value" id="dividendYield"></span></div>
                        <div class="data-point"><span class="label">טווח יומי (נמוך/גבוה)</span><span class="value" id="dayRange"></span></div>
                        <div class="data-point"><span class="label">ווליום (נפח מסחר)</span><span class="value" id="volume"></span></div>
                    </div>
                </div>

                <div id="financials" class="tab-content">
                    <h3>דוח רווח והפסד (רבעון אחרון)</h3>
                    <p>כל הסכומים ב-USD.</p>
                    <div class="data-grid" id="income-statement-grid"></div>
                </div>

                <div id="news" class="tab-content">
                    <h3>חדשות וסנטימנט</h3>
                    <ul class="news-list" id="news-list"></ul>
                </div>

                <div id="analysts" class="tab-content">
                    <h3>קונצנזוס אנליסטים</h3>
                    <p id="analyst-summary"></p>
                    <div id="analyst-chart-container">
                        <canvas id="analystChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- קוד ה-JavaScript ---

        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! שלב קריטי: החלף בכתובת שתקבל מ-Render !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const API_BASE_URL = "https://lanzafolio-server.onrender.com"; 

        let mainChart = null;
        let analystChart = null;

        const financialLabels = {
            "fiscalDateEnding": "תאריך סיום רבעון",
            "totalRevenue": "סה\"כ הכנסות",
            "costOfRevenue": "עלות הכנסות",
            "grossProfit": "רווח גולמי",
            "operatingIncome": "רווח תפעולי",
            "netIncome": "רווח נקי",
            "ebitda": "EBITDA"
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchMarketMovers();
        });

        async function fetchMarketMovers() {
            const loader = document.getElementById('loader');
            loader.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE_URL}/market-movers`);
                const data = await response.json();

                // טיפול ב-Top Gainers (עד 20)
                const gainersList = document.getElementById('top-gainers-list');
                gainersList.innerHTML = '';
                data.topGainers.forEach(stock => {
                    gainersList.innerHTML += `
                        <li>
                            <span class="symbol">${stock.ticker}</span>
                            <span class="change-gainer">+${stock.change_percentage}</span>
                        </li>
                    `;
                });

                // טיפול ב-Most Active (עד 20)
                const activeList = document.getElementById('most-active-list');
                activeList.innerHTML = '';
                data.mostActive.forEach(stock => {
                    activeList.innerHTML += `
                        <li>
                            <span class="symbol">${stock.ticker}</span>
                            <span class="volume">${Number(stock.volume).toLocaleString()}</span>
                        </li>
                    `;
                });

            } catch (error) {
                console.error("Error fetching market movers:", error);
                document.getElementById('homepage-view').innerHTML = "<p>שגיאה בטעינת נתוני השוק.</p>";
            } finally {
                loader.style.display = 'none';
            }
        }

        async function searchStock() {
            const symbol = document.getElementById('stockSymbol').value.toUpperCase();
            if (!symbol) {
                alert("אנא הכנס סימול מניה");
                return;
            }

            document.getElementById('homepage-view').style.display = 'none';
            document.getElementById('stock-details-view').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            try {
                const response = await fetch(`${API_BASE_URL}/stock-data?symbol=${symbol}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);
                if (!data.overview || !data.overview.Name) throw new Error("לא נמצא מידע עבור הסימול שהוכנס.");

                displayStockData(data);
                document.getElementById('stock-details-view').style.display = 'block';

            } catch (error) {
                console.error("Error fetching stock data:", error);
                alert(`שגיאה: ${error.message}`);
                document.getElementById('homepage-view').style.display = 'grid'; // החזר לדף הבית
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function displayStockData(data) {
            document.getElementById('companyName').innerText = data.overview.Name || 'N/A';
            document.getElementById('companyTicker').innerText = data.overview.Symbol || 'N/A';

            const price = data.quote.c.toFixed(2);
            const change = data.quote.d.toFixed(2);
            const changePercent = data.quote.dp.toFixed(2);
            const changeColor = change >= 0 ? 'var(--green)' : 'var(--red)';

            document.getElementById('stockPrice').innerText = `$${price}`;
            document.getElementById('stockChange').innerText = `${change} (${changePercent}%)`;
            document.getElementById('stockChange').style.color = changeColor;

            const flagsContainer = document.getElementById('flags');
            flagsContainer.innerHTML = '';
            if (data.flags.isUnusualVolume) {
                flagsContainer.innerHTML += `<span style="background: var(--primary-color); padding: 5px 10px; border-radius: 5px;">🔥 ווליום חריג</span>`;
            }

            document.getElementById('companyDescription').innerText = data.overview.Description || 'אין תיאור זמין.';
            document.getElementById('marketCap').innerText = Number(data.overview.MarketCapitalization).toLocaleString();
            document.getElementById('peRatio').innerText = data.overview.PERatio;
            document.getElementById('dividendYield').innerText = `${(Number(data.overview.DividendYield) * 100).toFixed(2)}%`;
            document.getElementById('dayRange').innerText = `$${data.quote.l.toFixed(2)} - $${data.quote.h.toFixed(2)}`;
            document.getElementById('volume').innerText = Number(data.quote.v).toLocaleString();

            const incomeReport = data.incomeStatement;
            const incomeGrid = document.getElementById('income-statement-grid');
            incomeGrid.innerHTML = '';
            if (incomeReport && Object.keys(incomeReport).length > 0) {
                for (const key in financialLabels) {
                    if (incomeReport[key]) {
                        const value = Number(incomeReport[key]) ? Number(incomeReport[key]).toLocaleString() : incomeReport[key];
                        incomeGrid.innerHTML += `
                            <div class="data-point">
                                <span class="label">${financialLabels[key]}</span>
                                <span class="value">${value}</span>
                            </div>
                        `;
                    }
                }
            } else {
                 incomeGrid.innerHTML = '<p>לא נמצאו דוחות כספיים.</p>';
            }

            const newsList = document.getElementById('news-list');
            newsList.innerHTML = '';
            if (data.news && data.news.length > 0) {
                data.news.slice(0, 15).forEach(item => {
                    newsList.innerHTML += `
                        <li class="news-item">
                            <a href="${item.url}" target="_blank">${item.title}</a>
                            <p>${item.summary}</p>
                            <small style="color: var(--text-secondary);">${item.source} - ${new Date(item.time_published).toLocaleString('he-IL')}</small>
                        </li>
                    `;
                });
            } else {
                newsList.innerHTML = '<p>לא נמצאו חדשות אחרונות.</p>';
            }

            const rec = data.recommendations;
            if (rec && rec.strongBuy) {
                document.getElementById('analyst-summary').innerText = `מבוסס על ${rec.buy + rec.strongBuy + rec.hold + rec.sell + rec.strongSell} אנליסטים (עודכן לאחרונה: ${rec.period})`;
                renderAnalystChart(rec);
            } else {
                document.getElementById('analyst-summary').innerText = 'אין נתוני אנליסטים זמינים.';
                if(analystChart) analystChart.destroy();
            }

            renderMainChart(data.chartData);
            showTab('overview');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        function renderMainChart(data) {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = '';
            if (mainChart) mainChart.remove();

            if (!data || !data.c || data.s === 'no_data') {
                chartContainer.innerText = "אין נתוני גרף זמינים.";
                return;
            }

            mainChart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: 400,
                layout: { backgroundColor: 'var(--surface-color)', textColor: 'var(--text-color)' },
                grid: { vertLines: { color: '#444' }, horzLines: { color: '#444' } },
                timeScale: { borderColor: '#777' },
            });

            const candleSeries = mainChart.addCandlestickSeries({
                upColor: 'var(--green)', downColor: 'var(--red)',
                borderDownColor: 'var(--red)', borderUpColor: 'var(--green)',
                wickDownColor: 'var(--red)', wickUpColor: 'var(--green)',
            });

            const chartData = data.t.map((time, index) => ({
                time: time,
                open: data.o[index], high: data.h[index],
                low: data.l[index], close: data.c[index],
            }));

            candleSeries.setData(chartData);
            mainChart.timeScale().fitContent();
        }

        function renderAnalystChart(data) {
            const ctx = document.getElementById('analystChart').getContext('2d');
            if (analystChart) analystChart.destroy();

            analystChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['קנייה חזקה', 'קנייה', 'החזקה', 'מכירה', 'מכירה חזקה'],
                    datasets: [{
                        label: 'מספר המלצות',
                        data: [data.strongBuy, data.buy, data.hold, data.sell, data.strongSell],
                        backgroundColor: ['var(--green)', 'rgba(40, 167, 69, 0.7)', 'var(--hold)', 'rgba(220, 53, 69, 0.7)', 'var(--sell)'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'var(--text-secondary)' }, grid: { color: '#444' } },
                        x: { ticks: { color: 'var(--text-secondary)' }, grid: { color: '#444' } }
                    }
                }
            });
        }
    </script>
</body>

</html>
